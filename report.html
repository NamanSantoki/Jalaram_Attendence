<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monthly Attendance Report</title>
  <link href="style.css" rel="stylesheet" />

  <!-- SheetJS (for Excel export) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Bootstrap CSS & JS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
  <!-- Bootstrap Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Jalaram Tools</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
              aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="main.html">Attendance</a></li>
          <li class="nav-item"><a class="nav-link" href="employees.html">Employees</a></li>
          <li class="nav-item"><a class="nav-link active" href="report.html">Monthly Report</a></li>
          <li class="nav-item"><a class="nav-link" href="salary.html">Salary Calculator</a></li>
          <li class="nav-item"><a class="nav-link" href="settings.html">Settings</a></li>
          <li class="nav-item"><a class="nav-link text-danger" href="index.html">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mt-4">
    <h1>Monthly Attendance Report</h1>
    <div class="card p-4">
      <div class="input-group mb-3">
        <input style="width: 30%;" id="monthInput" type="month" class="form-control" />
        <button onclick="generateReport()" class="btn btn-primary">Generate Report</button>
        <button onclick="downloadExcel()" class="btn btn-success ms-2">Download Excel</button>
      </div>
      <div id="monthInfo" class="month-info mb-2"></div>
      <div id="reportTable" class="table-responsive"></div>
    </div>
  </div>

  <!-- JavaScript Logic -->
  <script>
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      window.location.href = 'login.html';
    }

    function logout() {
      localStorage.removeItem('isLoggedIn');
      window.location.href = 'login.html';
    }

    function generateReport() {
      const month = document.getElementById('monthInput').value;
      if (!month) {
        alert('Please select a month.');
        return;
      }

      const [year, monthNum] = month.split('-');
      const employees = JSON.parse(localStorage.getItem('employees')) || [];
      const attendance = JSON.parse(localStorage.getItem('attendance')) || {};
      const daysInMonth = new Date(year, monthNum, 0).getDate();
      const weeks = Math.ceil(daysInMonth / 7);

      document.getElementById('monthInfo').innerHTML = `<p>Total Days in Month: ${daysInMonth}</p>`;

      let table = `
        <table class="table table-bordered">
          <thead class="table-light">
            <tr>
              <th>Employee</th>
              <th>Week 1<br>(1-7)</th>
              <th>Week 2<br>(8-14)</th>
              <th>Week 3<br>(15-21)</th>
              <th>Week 4<br>(22-28)</th>
              ${daysInMonth > 28 ? '<th>Week 5<br>(29-31)</th>' : ''}
              <th>Total Present</th>
              <th>Total Absent</th>
            </tr>
          </thead>
          <tbody>
      `;

      employees.forEach((emp, index) => {
        if (!emp || !emp.name) return;

        table += `<tr><td>${emp.name}</td>`;
        let totalPresent = 0;

        for (let week = 0; week < weeks; week++) {
          let weekAttendance = '';
          const startDay = week * 7 + 1;
          const endDay = Math.min(startDay + 6, daysInMonth);

          for (let day = startDay; day <= endDay; day++) {
            const date = `${year}-${monthNum.padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isPresent = attendance[date]?.[emp.name] || false;
            weekAttendance += isPresent ? '✔️' : '❌';
            if (isPresent) totalPresent++;
          }

          table += `<td>${weekAttendance}</td>`;
        }

        const totalAbsent = daysInMonth - totalPresent;
        table += `<td>${totalPresent}</td><td>${totalAbsent}</td></tr>`;
      });

      table += '</tbody></table>';
      document.getElementById('reportTable').innerHTML = table;
    }

    function downloadExcel() {
      const month = document.getElementById('monthInput').value;
      if (!month) {
        alert('Please select a month.');
        return;
      }

      const [year, monthNum] = month.split('-');
      const employees = JSON.parse(localStorage.getItem('employees')) || [];
      const attendance = JSON.parse(localStorage.getItem('attendance')) || {};
      const daysInMonth = new Date(year, monthNum, 0).getDate();
      const weeks = Math.ceil(daysInMonth / 7);

      const excelData = [];
      const headers = ['Employee', 'Week 1 (1-7)', 'Week 2 (8-14)', 'Week 3 (15-21)', 'Week 4 (22-28)'];
      if (daysInMonth > 28) headers.push('Week 5 (29-31)');
      headers.push('Total Present', 'Total Absent');
      excelData.push(headers);

      employees.forEach(emp => {
        if (!emp || !emp.name) return;
        let totalPresent = 0;
        const row = [emp.name];

        for (let week = 0; week < weeks; week++) {
          let weekData = '';
          const startDay = week * 7 + 1;
          const endDay = Math.min(startDay + 6, daysInMonth);

          for (let day = startDay; day <= endDay; day++) {
            const date = `${year}-${monthNum.padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isPresent = attendance[date]?.[emp.name] || false;
            weekData += isPresent ? '✔️' : '❌';
            if (isPresent) totalPresent++;
          }

          row.push(weekData);
        }

        const totalAbsent = daysInMonth - totalPresent;
        row.push(totalPresent, totalAbsent);
        excelData.push(row);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(excelData);
      XLSX.utils.book_append_sheet(wb, ws, 'Attendance Report');
      XLSX.writeFile(wb, `Attendance_Report_${year}-${monthNum}.xlsx`);
    }

    // Set current month on page load
    window.onload = () => {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      document.getElementById('monthInput').value = `${year}-${month}`;
    };
  </script>
</body>
</html>
