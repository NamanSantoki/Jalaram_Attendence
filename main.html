<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Marking</title>
  <link href="style.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    .shift-toggle-btn {
      padding: 4px 8px;
      font-size: 0.8rem;
      margin-left: 10px;
    }
    .shift-section {
      margin-top: 20px;
      border-top: 1px solid #e2e8f0;
      padding-top: 10px;
    }
    .shift-section h4 {
      color: #2c5282;
      margin-bottom: 15px;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      padding: 8px 0;
    }
    .attendance-status {
      margin-left: 10px;
      font-weight: bold;
      color: #2f855a;
    }
    .attendance-status.absent {
      color: #c53030;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #2f855a;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .toast.show {
      opacity: 1;
    }
    .attendance-toggle-btn {
      padding: 4px 8px;
      font-size: 0.8rem;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Jalaram Tools</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="main.html">Attendance</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="employees.html">Employees</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="report.html">Monthly Report</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="Loan&Adv.html">Loan</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="settings.html">Settings</a>
          </li>
          <li class="nav-item">
            <a class="nav-link text-danger" href="index.html">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container">
    <h1>Mark Attendance</h1>
    <div class="card">
      <h2>Attendance for Selected Date</h2>
      <div class="input-group">
        <input style="width: 50%;" id="attendanceDate" type="date" class="form-control">
        <button onclick="saveAttendance()" id="saveButton" class="btn btn-primary">Save</button>
        <button onclick="resetAttendance()" id="resetButton" class="btn btn-danger">Reset</button>
      </div>
      <div id="lockMessage" class="lock-message"></div>
      <div class="attendance-info" id="attendance-info"></div>
      <div class="checkbox-group">
        <input type="checkbox" id="show-present-only" onchange="loadEmployeesForAttendance()">
        <label for="show-present-only">Show Present Employees Only</label>
      </div>
      <div id="attendanceList" class="attendance-list">
        <div class="shift-section" id="morningShiftSection">
          <h4>Morning Shift</h4>
          <div id="morningShiftList"></div>
        </div>
        <div class="shift-section" id="nightShiftSection">
          <h4>Night Shift</h4>
          <div id="nightShiftList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    if (localStorage.getItem('isLoggedIn') !== 'true') {
      window.location.href = 'index.html';
    }

    function logout() {
      localStorage.removeItem('isLoggedIn');
      window.location.href = 'index.html';
    }

    let employees = JSON.parse(localStorage.getItem('employees')) || [];
    let attendance = JSON.parse(localStorage.getItem('attendance')) || {};
    let lockedDates = JSON.parse(localStorage.getItem('lockedDates')) || [];
    let unlockedDates = JSON.parse(localStorage.getItem('unlockedDates')) || [];
    let shifts = JSON.parse(localStorage.getItem('shifts')) || {};

    // Validate and clean employee data
    employees = employees.filter(emp => emp && typeof emp === 'object' && emp.name && !isNaN(emp.basic) && !isNaN(emp.hra) && !isNaN(emp.conveyance) && !isNaN(emp.others) && !isNaN(emp.totalSalary));
    localStorage.setItem('employees', JSON.stringify(employees));

    function loadEmployeesForAttendance() {
      const date = document.getElementById('attendanceDate').value;
      const lockMessage = document.getElementById('lockMessage');
      const saveButton = document.getElementById('saveButton');
      const resetButton = document.getElementById('resetButton');
      const morningList = document.getElementById('morningShiftList');
      const nightList = document.getElementById('nightShiftList');
      const showPresentOnly = document.getElementById('show-present-only').checked;

      if (!date) {
        lockMessage.textContent = '';
        saveButton.disabled = true;
        resetButton.disabled = true;
        morningList.innerHTML = '';
        nightList.innerHTML = '';
        document.getElementById('attendance-info').textContent = '';
        return;
      }

      const isLocked = lockedDates.includes(date) && !unlockedDates.includes(date);
      lockMessage.textContent = isLocked ? `Attendance for ${formatDate(date)} is locked. Unlock in Settings to modify.` : '';
      saveButton.disabled = isLocked;
      resetButton.disabled = isLocked;

      morningList.innerHTML = '';
      nightList.innerHTML = '';

      if (employees.length === 0) {
        morningList.innerHTML = '<p class="no-data">No employees found. Add employees first.</p>';
        document.getElementById('attendance-info').textContent = '';
        return;
      }

      shifts[date] = shifts[date] || {};
      let presentCount = 0;
      employees.forEach(emp => {
        if (!emp || !emp.name || isNaN(emp.totalSalary)) return;

        if (!shifts[date][emp.name]) {
          shifts[date][emp.name] = 'morning';
        }
        const shift = shifts[date][emp.name];
        const isPresent = attendance[date]?.[emp.name] !== undefined ? attendance[date][emp.name] : true;
        if (isPresent) presentCount++;

        if (showPresentOnly && !isPresent) return;

        const targetList = shift === 'morning' ? morningList : nightList;
        const div = document.createElement('div');
        div.className = 'checkbox-group';
        div.innerHTML = `
          <button class="btn btn-sm btn-outline-${isPresent ? 'success' : 'danger'} attendance-toggle-btn" id="${emp.name}-${date}" onclick="updateAttendanceStatus('${emp.name}', '${date}')" ${isLocked ? 'disabled' : ''}>${isPresent ? 'Present' : 'Absent'}</button>
          <label class="employee-label">
            <span class="emp-name">${emp.name}</span>
            <span class="emp-salary">₹${emp.totalSalary}/month</span>
            <span id="status-${emp.name}-${date}" class="attendance-status ${isPresent ? '' : 'absent'}">${isPresent ? 'Present' : 'Absent'}</span>
          </label>
          <button class="btn btn-sm btn-outline-primary shift-toggle-btn" onclick="toggleShift('${emp.name}', '${date}')" ${isLocked ? 'disabled' : ''}>↑↓</button>
        `;
        targetList.appendChild(div);
      });
      localStorage.setItem('shifts', JSON.stringify(shifts));
      document.getElementById('attendance-info').textContent = `Present: ${presentCount} / ${employees.length}`;
    }

    function updateAttendanceStatus(empName, date) {
      attendance[date] = attendance[date] || {};
      attendance[date][empName] = !attendance[date][empName]; // Toggle true/false
      loadEmployeesForAttendance();
      showToast(`Attendance updated for ${empName}`);
    }

    function toggleShift(empName, date) {
      shifts[date] = shifts[date] || {};
      shifts[date][empName] = shifts[date][empName] === 'morning' ? 'night' : 'morning';
      localStorage.setItem('shifts', JSON.stringify(shifts));
      loadEmployeesForAttendance();
      showToast(`Shift updated for ${empName}`);
    }

    function saveAttendance() {
      const date = document.getElementById('attendanceDate').value;
      if (!date) {
        alert('Please select a date.');
        return;
      }

      attendance[date] = attendance[date] || {};
      employees.forEach(emp => {
        if (!emp || !emp.name) return;
        attendance[date][emp.name] = attendance[date][emp.name] !== undefined ? attendance[date][emp.name] : true;
      });
      localStorage.setItem('attendance', JSON.stringify(attendance));

      if (!lockedDates.includes(date)) {
        lockedDates.push(date);
        localStorage.setItem('lockedDates', JSON.stringify(lockedDates));
      }

      loadEmployeesForAttendance();
      showToast('Attendance saved successfully!');
    }

    function resetAttendance() {
      const date = document.getElementById('attendanceDate').value;
      if (!date) {
        alert('Please select a date.');
        return;
      }
      if (!confirm('Reset all attendance to absent for this date?')) return;

      attendance[date] = attendance[date] || {};
      employees.forEach(emp => {
        if (!emp || !emp.name) return;
        attendance[date][emp.name] = false;
      });
      localStorage.setItem('attendance', JSON.stringify(attendance));
      loadEmployeesForAttendance();
      showToast('Attendance reset successfully!');
    }

    function formatDate(dateString) {
      const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString('en-US', options);
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => {
            document.body.removeChild(toast);
          }, 300);
        }, 2000);
      }, 10);
    }

    window.onload = () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('attendanceDate').value = today;
      document.getElementById('attendanceDate').addEventListener('change', loadEmployeesForAttendance);
      loadEmployeesForAttendance();
    };
  </script>
</body>
</html>